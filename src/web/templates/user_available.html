<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIS Parser - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="control-panel">
            <div class="branding">
                <div class="logo">EIS Parser v2.0</div>
                <nav class="main-nav">
                    <a href="/">Stage 1: Intake</a>
                    <a href="/stage2">Stage 2: AI Review</a>
                    <a href="/user/available" class="active">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏</a>
                    <a href="/user/selections">–ú–æ–∏ –≤—ã–±–æ—Ä–∫–∏</a>
                </nav>
            </div>

            <div class="stats-panel">
                <div class="stat-item total">
                    <span class="label">–î–æ—Å—Ç—É–ø–Ω–æ</span>
                    <span class="value" id="stat-total">0</span>
                </div>
                <div class="stat-item approved">
                    <span class="label">–í—ã–±—Ä–∞–Ω–æ</span>
                    <span class="value" id="stat-selected">0</span>
                </div>
            </div>
        </header>

        <!-- Actions -->
        <div class="actions-bar">
            <button id="btn-select" class="btn btn-primary" disabled>
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –≤—ã–±–æ—Ä–∫—É
            </button>
            <button id="btn-refresh" class="btn" style="background-color: #64748b; margin-left: 10px;">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <span id="status-msg" class="status-msg"></span>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table id="zakupki-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all">
                        </th>
                        <th>–†–µ–≥. –Ω–æ–º–µ—Ä</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–ì–æ—Ä–æ–¥</th>
                        <th>–ü–ª–æ—â–∞–¥—å</th>
                        <th>–ö–æ–º–Ω–∞—Ç</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="zakupki-tbody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const userId = 1; // Hardcoded –¥–ª—è MVP
        let zakupki = [];
        let selectedIds = new Set();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const response = await fetch(`/api/user/available_zakupki?user_id=${userId}`);
                const data = await response.json();
                
                zakupki = data.zakupki || [];
                renderTable();
                updateStats();
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const tbody = document.getElementById('zakupki-tbody');
            
            if (zakupki.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫—É–ø–æ–∫</td></tr>';
                return;
            }

            tbody.innerHTML = zakupki.map(z => `
                <tr>
                    <td><input type="checkbox" class="row-select" data-reg="${z.reg_number}" ${z.is_selected ? 'checked' : ''}></td>
                    <td>${z.reg_number}</td>
                    <td>${z.description || '-'}</td>
                    <td>${z.city || '-'}</td>
                    <td>${z.area || '-'}</td>
                    <td>${z.rooms || '-'}</td>
                    <td>${z.initial_price ? (z.initial_price / 1000000).toFixed(2) + ' –º–ª–Ω' : '-'}</td>
                    <td><span class="badge">${z.status}</span></td>
                </tr>
            `).join('');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const regNumber = e.target.dataset.reg;
                    if (e.target.checked) {
                        selectedIds.add(regNumber);
                    } else {
                        selectedIds.delete(regNumber);
                    }
                    updateButtons();
                });
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        function updateButtons() {
            const btn = document.getElementById('btn-select');
            btn.disabled = selectedIds.size === 0;
            btn.textContent = selectedIds.size > 0 ? `‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –≤—ã–±–æ—Ä–∫—É (${selectedIds.size})` : '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –≤—ã–±–æ—Ä–∫—É';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            document.getElementById('stat-total').textContent = zakupki.length;
            const selectedCount = zakupki.filter(z => z.is_selected).length;
            document.getElementById('stat-selected').textContent = selectedCount;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≤—ã–±–æ—Ä–∫—É
        async function addToSelection() {
            const btn = document.getElementById('btn-select');
            btn.disabled = true;
            btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';

            try {
                const response = await fetch('/api/user/select', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        reg_numbers: Array.from(selectedIds)
                    })
                });

                const result = await response.json();
                showStatus(result.message, 'success');
                
                selectedIds.clear();
                loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                btn.disabled = false;
            }
        }

        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type = 'info') {
            const el = document.getElementById('status-msg');
            el.textContent = message;
            el.style.color = type === 'error' ? '#ef4444' : (type === 'success' ? '#10b981' : '#64748b');
            setTimeout(() => el.textContent = '', 5000);
        }

        // Select All
        document.getElementById('select-all').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                const regNumber = cb.dataset.reg;
                if (e.target.checked) {
                    selectedIds.add(regNumber);
                } else {
                    selectedIds.delete(regNumber);
                }
            });
            updateButtons();
        });

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('btn-select').addEventListener('click', addToSelection);
        document.getElementById('btn-refresh').addEventListener('click', loadData);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>

</html>
