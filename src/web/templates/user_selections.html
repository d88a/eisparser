<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIS Parser - –ú–æ–∏ –≤—ã–±–æ—Ä–∫–∏</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="control-panel">
            <div class="branding">
                <div class="logo">EIS Parser v2.0</div>
                <nav class="main-nav">
                    <a href="/">Stage 1: Intake</a>
                    <a href="/stage2">Stage 2: AI Review</a>
                    <a href="/user/available">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏</a>
                    <a href="/user/selections" class="active">–ú–æ–∏ –≤—ã–±–æ—Ä–∫–∏</a>
                </nav>
            </div>

            <div class="stats-panel">
                <div class="stat-item total">
                    <span class="label">–í –≤—ã–±–æ—Ä–∫–µ</span>
                    <span class="value" id="stat-total">0</span>
                </div>
            </div>
        </header>

        <!-- Actions -->
        <div class="actions-bar">
            <button id="btn-run-stage4" class="btn btn-primary" disabled>
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            </button>
            <button id="btn-clear" class="btn" style="background-color: #ef4444; margin-left: 10px;" disabled>
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä–∫—É
            </button>
            <button id="btn-refresh" class="btn" style="background-color: #64748b; margin-left: 10px;">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <span id="status-msg" class="status-msg"></span>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table id="zakupki-table">
                <thead>
                    <tr>
                        <th>–†–µ–≥. –Ω–æ–º–µ—Ä</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–ì–æ—Ä–æ–¥</th>
                        <th>–ü–ª–æ—â–∞–¥—å</th>
                        <th>–ö–æ–º–Ω–∞—Ç</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>2–ì–ò–°</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="zakupki-tbody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const userId = 1; // Hardcoded –¥–ª—è MVP
        let zakupki = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const response = await fetch(`/api/user/selections?user_id=${userId}`);
                const data = await response.json();
                
                zakupki = data.zakupki || [];
                renderTable();
                updateStats();
                updateButtons();
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const tbody = document.getElementById('zakupki-tbody');
            
            if (zakupki.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–æ–∫. <a href="/user/available">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫—É–ø–∫–∏</a></td></tr>';
                return;
            }

            tbody.innerHTML = zakupki.map(z => `
                <tr>
                    <td>${z.reg_number}</td>
                    <td>${z.description || '-'}</td>
                    <td>${z.city || '-'}</td>
                    <td>${z.area || '-'}</td>
                    <td>${z.rooms || '-'}</td>
                    <td>${z.initial_price ? (z.initial_price / 1000000).toFixed(2) + ' –º–ª–Ω' : '-'}</td>
                    <td>${z.two_gis_url ? '<a href="' + z.two_gis_url + '" target="_blank">üîó –û—Ç–∫—Ä—ã—Ç—å</a>' : '-'}</td>
                    <td>
                        <button class="btn-small btn-remove" data-reg="${z.reg_number}">‚ùå</button>
                    </td>
                </tr>
            `).join('');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const regNumber = e.target.dataset.reg;
                    await removeFromSelection(regNumber);
                });
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        function updateButtons() {
            const hasItems = zakupki.length > 0;
            document.getElementById('btn-run-stage4').disabled = !hasItems;
            document.getElementById('btn-clear').disabled = !hasItems;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            document.getElementById('stat-total').textContent = zakupki.length;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –≤—ã–±–æ—Ä–∫–∏
        async function removeFromSelection(regNumber) {
            try {
                const response = await fetch('/api/user/unselect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        reg_numbers: [regNumber]
                    })
                });

                const result = await response.json();
                showStatus('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –≤—ã–±–æ—Ä–∫–∏', 'success');
                loadData();
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –ó–∞–ø—É—Å–∫ Stage 4
        async function runStage4() {
            const btn = document.getElementById('btn-run-stage4');
            btn.disabled = true;
            btn.textContent = '‚è≥ –°–±–æ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π...';

            try {
                const response = await fetch('/api/user/run_stage4', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        top_n: 20,
                        get_details: false
                    })
                });

                const result = await response.json();
                showStatus(result.message, result.status === 'ok' ? 'success' : 'error');
                
                if (result.status === 'ok') {
                    loadData(); // –í—ã–±–æ—Ä–∫–∞ –æ—á–∏—â–µ–Ω–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
                }
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π';
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∫–∏
        async function clearSelection() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –≤—ã–±–æ—Ä–∫—É?')) return;

            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ reg_numbers
                const regNumbers = zakupki.map(z => z.reg_number);
                
                const response = await fetch('/api/user/unselect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        reg_numbers: regNumbers
                    })
                });

                const result = await response.json();
                showStatus('–í—ã–±–æ—Ä–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
                loadData();
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type = 'info') {
            const el = document.getElementById('status-msg');
            el.textContent = message;
            el.style.color = type === 'error' ? '#ef4444' : (type === 'success' ? '#10b981' : '#64748b');
            setTimeout(() => el.textContent = '', 5000);
        }

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('btn-run-stage4').addEventListener('click', runStage4);
        document.getElementById('btn-clear').addEventListener('click', clearSelection);
        document.getElementById('btn-refresh').addEventListener('click', loadData);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>

</html>
