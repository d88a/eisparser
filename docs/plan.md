I. Общий архитектурный план (Human-in-the-Loop Workflow)
Цель

Добавить визуальный, управляемый человеком workflow, не ломая существующий пайплайн и не усложняя его преждевременно.

Ключевая идея:

Данные — общие, решения — пользовательские, пайплайн — персональный.

Архитектурные слои
1. Core pipeline (уже есть)

Stage 1–4 остаются без изменений по логике

Все вычисления по-прежнему привязаны к reg_number

2. Workflow layer (новый)

Добавляется слой:

хранения решений пользователя;

фильтрации закупок по этим решениям;

управления тем, какие закупки идут на следующий этап.

3. UI / Visualization (следующий шаг, не сейчас)

сначала данные + API

UI подключается поверх готовой модели

Канонический сценарий пользователя

Запустить Stage 1

Посмотреть список закупок

Для каждой:

approve / reject / skip

(опционально) комментарий

Нажать «Запустить Stage 2»

Stage 2 обрабатывает только approved

Повторить для Stage 3 и Stage 4

II. Минимальная архитектурная модель (что добавляем)
1. Пользователи (даже если сейчас один)
users
- id
- email
- role
- created_at


Сейчас можно создать одного пользователя вручную (admin).

2. Решения пользователей (ключевая таблица)
decisions
- id
- user_id
- reg_number
- stage        (1 | 2 | 3 | 4)
- decision     ('approved' | 'rejected' | 'skipped')
- comment      (nullable)
- created_at


Важно:

решения не перезаписываются;

новая запись = новое решение;

«актуальное» решение — последнее по времени.

3. Pipeline становится параметризованным

Логически (не обязательно в коде сразу):

Pipeline(user_id)


Все выборки делаются через:

WHERE reg_number IN (
  SELECT reg_number
  FROM decisions
  WHERE user_id = ?
    AND stage = ?
    AND decision = 'approved'
)

III. Пошаговый план внедрения (по порядку)
Этап 1 — Фундамент (без UI)

Таблицы users, decisions

Репозиторий для decisions

Простейшие CRUD-методы

Выборка approved-закупок по этапу

Этап 2 — Интеграция с Pipeline

Методы:

get_approved_for_stage(user_id, stage)

Запуск Stage N только по approved

Логи + тесты на корректность фильтрации

Этап 3 — Подготовка под визуализацию

DTO / view-модели:

список закупок + статус

API-методы (даже если UI ещё нет)

Документирование сценариев