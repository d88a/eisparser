 Задание стажёру (Этап 2): API/UI-интеграция статусов и пользовательских выборок

## 0) Контекст
Этап 1 завершён: база данных расширена статусами закупок и таблицей пользовательских выборок. Теперь нужно встроить это в API/пайплайн/минимальный UI так, чтобы:
- админ заранее готовил закупки (Stage 1–3),
- пользователь быстро выбирал готовые закупки,
- Stage 4 запускался только пользователем (для актуальных объявлений).

## 1) Цель этапа
Сделать API‑контур и минимальную интеграцию в UI, чтобы статусы закупок и пользовательские выборки начали реально работать в приложении.

## 2) Что уже сделано (важно учитывать)
В Этапе 1 добавлены:
- поля `status`, `prepared_by_user_id`, `prepared_at` в `zakupki`;
- статусы: `raw`, `ai_processing`, `ai_ready`, `url_ready`, `user_selected`, `listings_fresh`, `listings_stale`;
- репозиторий `UserSelectionRepository` и таблица `user_selections`.

Твоя задача — **использовать эту инфраструктуру**, не меняя принципы проекта:
- Stage 4 запускается **только пользователем**;
- `AIResult` read‑only, правки идут через overrides;
- данные пользователей не смешиваются.

## 3) Основные задачи

### 3.1. Добавить статусы в пайплайн (минимально, без поломок)
В `Pipeline` добавить обновление статусов при прохождении стадий:
- `run_stage1()` → выставляет `status='raw'`
- `run_stage2()` → `status='ai_ready'`
- `run_stage3()` → `status='url_ready'`
- `run_stage4()` → `status='listings_fresh'`

⚠️ Важно: **не запускать Stage 4 автоматически**, только вручную по запросу пользователя.

### 3.2. API для пользователя (минимальный набор)
Добавить в `src/api/routes.py` эндпоинты:
- `GET /api/user/available_zakupki` — возвращает закупки со статусом `url_ready`
- `POST /api/user/select` — добавить закупку в выборку пользователя
- `POST /api/user/unselect` — удалить закупку из выборки пользователя
- `GET /api/user/selections` — список выбранных рег. номеров
- `POST /api/user/run_stage4` — запускает Stage 4 для выбранных закупок

### 3.3. API для админа
Добавить эндпоинты:
- `GET /api/admin/pipeline_status` — статистика по статусам (`raw/ai_ready/url_ready/...`)
- `POST /api/admin/batch_stage2` — массовый запуск Stage 2 для `raw`
- `POST /api/admin/batch_stage3` — массовая генерация ссылок для `ai_ready`

### 3.4. Минимальные изменения UI
В шаблонах (в `src/web/templates/`) добавить/обновить:
- экран **User: доступные закупки** (таблица + чекбоксы + кнопки «Добавить/Удалить»)
- экран **User: выбранные закупки** (кнопка «Запустить Stage 4»)

UI может быть простым, главное — чтобы показывал:
- статус закупки,
- выбор пользователя,
- возможность запуска Stage 4 вручную.

## 4) Требования к качеству
- Не ломать существующие маршруты Stage 1–2.
- Все изменения должны быть обратно совместимы.
- Использовать репозитории из `DatabaseService` (не писать SQL напрямую в API).

## 5) Артефакты, которые нужно сдать
1. Код (API + минимальные UI правки).
2. Документация: краткий README/отчёт (1–2 страницы) с описанием:
   - какие эндпоинты добавлены
   - как работает пользовательский flow
   - как работает админский flow
3. Список затронутых файлов.

## 6) Приёмка
Считается выполненным, если:
- Пользователь может получить список готовых закупок (`url_ready`).
- Пользователь может выбрать закупки и вручную запустить Stage 4.
- Админ может массово прогнать Stage 2 и Stage 3 по статусам.
- Stage 4 не запускается автоматически.

## 7) Подсказки (не обязательно, но полезно)
- Для подсчёта статистики по статусам можно добавить метод `count_by_status` в `ZakupkaRepository`.
- Для Stage 4 желательно проверять, что URL уже есть (status `url_ready`).
- Если Stage 4 завершился, статус ставить `listings_fresh`.
